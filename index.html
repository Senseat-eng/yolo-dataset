<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¥‘ YOLO Dataset Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/umd/supabase.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .login-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .user-input {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            margin: 10px;
            min-width: 200px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            color: white;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(45deg, #56ab2f, #a8e6cf); }
        .btn-danger { background: linear-gradient(45deg, #ff416c, #ff4b2b); }
        .btn-warning { background: linear-gradient(45deg, #ffa726, #ffcc02); }
        
        .main-content {
            display: none;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 10px;
            margin: 5px;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 14px;
        }
        
        .tab.active {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .category-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
        }
        
        .category-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .category-btn.selected {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            border-color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .canvas-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #imageCanvas {
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            cursor: crosshair;
            max-width: 100%;
            max-height: 70vh;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .quality-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .quality-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .quality-slider {
            width: 200px;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #ff4757 0%, #ffa502 50%, #2ed573 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .quality-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 3px solid #667eea;
        }
        
        .quality-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 3px solid #667eea;
        }
        
        .rating-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        #ratingValue {
            font-size: 1.2em;
            color: #ffd700;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            color: #ffd700;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .image-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .image-card-info {
            padding: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            font-size: 1.2em;
            opacity: 0.8;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.3s ease;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
        }
        
        .notification.error {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }
        
        .export-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .categories {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                font-size: 12px;
            }
            
            .tab {
                padding: 10px;
            }
            
            .quality-slider {
                width: 150px;
            }
            
            #imageCanvas {
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¥‘ YOLO Dataset Creator</h1>
            <p class="subtitle">××•×¡×£ ×ª×ž×•× ×•×ª ×ž×©×•×ª×£ ×œ××™×ž×•×Ÿ ×ž×•×“×œ ×–×™×”×•×™</p>
        </div>
        
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>ðŸš€ ×‘×•× × ×ª×—×™×œ!</h2>
            <p>×”×›× ×¡ ××ª ×”×©× ×©×œ×š ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×¨×•× ×ª×ž×•× ×•×ª</p>
            <input type="text" id="userName" class="user-input" placeholder="×”×©× ×©×œ×š" maxlength="20">
            <br>
            <button onclick="login()" class="btn btn-primary">×”×ª×—×œ ×œ×ª×¨×•×</button>
        </div>
        
        <!-- Main App -->
        <div id="mainApp" class="main-content">
            <!-- User Info -->
            <div class="login-section">
                <p>×©×œ×•× <strong id="currentUser"></strong>! ðŸ‘‹</p>
                <button onclick="logout()" class="btn btn-danger">×”×ª× ×ª×§</button>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('upload')">ðŸ“· ×”×¢×œ××”</div>
                <div class="tab" onclick="switchTab('gallery')">ðŸ–¼ï¸?×’×œ×¨×™×”</div>
                <div class="tab" onclick="switchTab('stats')">ðŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</div>
                <div class="tab" onclick="switchTab('export')">ðŸ“¤ ×™×™×¦×•×</div>
            </div>
            
            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content active">
                <h3>×”×¢×œ××ª ×ª×ž×•× ×” ×—×“×©×”</h3>
                
                <!-- Upload Zone -->
                <div class="upload-zone" onclick="document.getElementById('imageInput').click()">
                    <h3>ðŸ“· ×¦×œ× ××• ×”×¢×œ×” ×ª×ž×•× ×”</h3>
                    <p>×œ×—×¥ ×›××Ÿ ××• ×’×¨×•×¨ ×ª×ž×•× ×”</p>
                    <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">×ª×ž×•× ×•×ª ×™×™×©×ž×¨×• ×‘×ž×¡×“ × ×ª×•× ×™× ×ž×©×•×ª×£</p>
                    <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none">
                </div>
                
                <!-- Category Selection -->
                <div id="categorySection" class="hidden">
                    <h3>×‘×—×¨ ××ª ×¡×•×’ ×”×ž×•×¦×¨:</h3>
                    <div class="categories">
                        <button class="category-btn" data-category="0">ðŸ¥‘ ××‘×•×§×“×•</button>
                        <button class="category-btn" data-category="1">ðŸ¥­ ×ž× ×’×•</button>
                        <button class="category-btn" data-category="2">ðŸ¥’ ×ž×œ×¤×¤×•×Ÿ</button>
                        <button class="category-btn" data-category="3">ðŸŽ ×ª×¤×•×—</button>
                        <button class="category-btn" data-category="4">ðŸ… ×¢×’×‘× ×™×”</button>
                        <button class="category-btn" data-category="5">ðŸ— ×—×–×” ×¢×•×£</button>
                    </div>
                </div>
                
                <!-- Canvas -->
                <div id="canvasSection" class="hidden">
                    <div class="canvas-container">
                        <canvas id="imageCanvas"></canvas>
                    </div>
                    
                    <p><strong>×”×•×¨××•×ª:</strong> ×‘×—×¨ ×§×˜×’×•×¨×™×” ×•××– ×œ×—×¥ ×•×’×¨×•×¨ ×¢×œ ×”×ª×ž×•× ×” ×œ×™×¦×™×¨×ª ×¨×™×‘×•×¢ ×¡×‘×™×‘ ×”×ž×•×¦×¨</p>
                    
                    <!-- Quality Rating -->
                    <div class="quality-section">
                        <h4>â­?×“×¨×’ ××ª ××™×›×•×ª ×”×ž×•×¦×¨ (××•×¤×¦×™×•× ×œ×™):</h4>
                        <div class="quality-rating">
                            <span>0</span>
                            <input type="range" id="qualitySlider" min="0" max="10" value="7" class="quality-slider">
                            <span>10</span>
                        </div>
                        <div class="rating-display">
                            <span id="ratingValue">7</span>/10 - <span id="ratingText">×˜×•×‘</span>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button onclick="saveAnnotation()" class="btn btn-success">ðŸ’¾ ×©×ž×•×¨</button>
                        <button onclick="clearCanvas()" class="btn btn-danger">ðŸ—‘ï¸?× ×§×”</button>
                        <button onclick="resetUpload()" class="btn btn-primary">ðŸ”„ ×ª×ž×•× ×” ×—×“×©×”</button>
                    </div>
                </div>
            </div>
            
            <!-- Gallery Tab -->
            <div id="galleryTab" class="tab-content">
                <h3>×’×œ×¨×™×™×ª ×”×ª×ž×•× ×•×ª ×”×ž×©×•×ª×¤×ª</h3>
                <button onclick="loadGallery()" class="btn btn-warning">ðŸ”„ ×¨×¢× ×Ÿ</button>
                <div id="imageGallery" class="image-grid">
                    <div class="loading">×˜×•×¢×Ÿ ×ª×ž×•× ×•×ª...</div>
                </div>
            </div>
            
            <!-- Stats Tab -->
            <div id="statsTab" class="tab-content">
                <h3>×¡×˜×˜×™×¡×˜×™×§×•×ª ×”×¤×¨×•×™×§×˜</h3>
                <button onclick="loadStats()" class="btn btn-warning">ðŸ”„ ×¨×¢× ×Ÿ</button>
                <div id="statsContainer" class="stats-grid">
                    <div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
                </div>
            </div>
            
            <!-- Export Tab -->
            <div id="exportTab" class="tab-content">
                <div class="export-section">
                    <h3>ðŸ“¤ ×™×™×¦×•× × ×ª×•× ×™× ×œ××™×ž×•×Ÿ YOLO</h3>
                    <p>×”×•×¨×“ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘×¤×•×¨×ž×˜ YOLO ×œ××™×ž×•×Ÿ ×”×ž×•×“×œ</p>
                    <button onclick="exportDataset()" class="btn btn-success">ðŸ“¥ ×”×•×¨×“ Dataset</button>
                    <div id="exportProgress" class="hidden">
                        <p>×ž×›×™×Ÿ ×§×•×‘×¥... ×× × ×”×ž×ª×Ÿ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ðŸš¨ IMPORTANT: Replace these with your Supabase credentials
        const SUPABASE_URL = 'https://kwoiohzrzmwkxkihkogb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3b2lvaHpyem13a3hraWhrb2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4Mzk2MjIsImV4cCI6MjA3MjQxNTYyMn0.FK1zrvXNc-nmoV28Nr4K12MuwC_zAe5QPcZmwDSbCfw';
        
        // Initialize Supabase - only if credentials are provided
        let supabase = null;
        if (SUPABASE_URL !== 'https://kwoiohzrzmwkxkihkogb.supabase.co' && SUPABASE_ANON_KEY !== 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3b2lvaHpyem13a3hraWhrb2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4Mzk2MjIsImV4cCI6MjA3MjQxNTYyMn0.FK1zrvXNc-nmoV28Nr4K12MuwC_zAe5QPcZmwDSbCfw') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
        
        // Global variables
        let currentUser = '';
        let currentImage = null;
        let selectedCategory = null;
        let isDrawing = false;
        let annotations = [];
        let startX, startY;
        
        const categories = ['avocado', 'mango', 'cucumber', 'apple', 'tomato', 'chicken_breast'];
        const categoryNames = ['××‘×•×§×“×•', '×ž× ×’×•', '×ž×œ×¤×¤×•×Ÿ', '×ª×¤×•×—', '×¢×’×‘× ×™×”', '×—×–×” ×¢×•×£'];
        const ratingTexts = {
            0: '×’×¨×•×¢ ×ž××•×“', 1: '×’×¨×•×¢', 2: '×’×¨×•×¢', 3: '×’×¨×•×¢',
            4: '×‘×™× ×•× ×™', 5: '×‘×™× ×•× ×™', 6: '×‘×™× ×•× ×™',
            7: '×˜×•×‘', 8: '×˜×•×‘', 9: '×ž×¢×•×œ×”', 10: '×ž×¢×•×œ×”'
        };
        
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            initQualitySlider();
            checkExistingUser();
            
            // Check if Supabase is configured
            if (!supabase) {
                showNotification('âš ï¸ ×ž×¡×“ ×”× ×ª×•× ×™× ×œ× ×ž×•×’×“×¨ - ×¢×•×‘×“ ×‘×ž×¦×‘ ×œ×•×§×œ×™ ×‘×œ×‘×“', 'error');
            }
        });
        
        function initEventListeners() {
            // Image upload
            const imageInput = document.getElementById('imageInput');
            imageInput.addEventListener('change', handleImageUpload);
            
            // Category buttons
            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', () => selectCategory(btn));
            });
            
            // Canvas events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', drawBoundingBox);
            canvas.addEventListener('mouseup', endDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(getTouchPos(e));
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                drawBoundingBox(getTouchPos(e));
            });
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                endDrawing(getTouchPos(e));
            });
            
            // Drag and drop
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', (e) => {
                e.currentTarget.classList.remove('dragover');
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    loadImageFile(files[0]);
                }
            });
        }
        
        function initQualitySlider() {
            const slider = document.getElementById('qualitySlider');
            const ratingValue = document.getElementById('ratingValue');
            const ratingText = document.getElementById('ratingText');
            
            slider.addEventListener('input', (e) => {
                const value = e.target.value;
                ratingValue.textContent = value;
                ratingText.textContent = ratingTexts[value];
            });
        }
        
        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                clientX: e.touches[0].clientX,
                clientY: e.touches[0].clientY
            };
        }
        
        function checkExistingUser() {
            const savedUser = localStorage.getItem('yolo_user');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('currentUser').textContent = currentUser;
                showMainApp();
                loadStats();
                loadGallery();
            }
        }
        
        function login() {
            const userName = document.getElementById('userName').value.trim();
            if (!userName) {
                showNotification('×× × ×”×›× ×¡ ×©×', 'error');
                return;
            }
            
            if (userName.length > 20) {
                showNotification('×”×©× ××¨×•×š ×ž×“×™ (×ž×§×¡×™×ž×•× 20 ×ª×•×•×™×)', 'error');
                return;
            }
            
            currentUser = userName;
            localStorage.setItem('yolo_user', currentUser);
            document.getElementById('currentUser').textContent = currentUser;
            showMainApp();
            loadStats();
            loadGallery();
        }
        
        function logout() {
            localStorage.removeItem('yolo_user');
            currentUser = '';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            resetUpload();
        }
        
        function showMainApp() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${getTabIndex(tabName)})`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load content if needed
            if (tabName === 'stats') loadStats();
            if (tabName === 'gallery') loadGallery();
        }
        
        function getTabIndex(tabName) {
            const tabs = ['upload', 'gallery', 'stats', 'export'];
            return tabs.indexOf(tabName) + 1;
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                loadImageFile(file);
            }
        }
        
        function loadImageFile(file) {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showNotification('×§×•×‘×¥ ×’×“×•×œ ×ž×“×™ (×ž×§×¡×™×ž×•× 10MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    setupCanvas();
                    drawImage();
                    document.getElementById('categorySection').classList.remove('hidden');
                    document.getElementById('canvasSection').classList.remove('hidden');
                    annotations = [];
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function setupCanvas() {
            const maxWidth = Math.min(600, window.innerWidth - 60);
            const maxHeight = 500;
            
            let { width, height } = currentImage;
            const aspectRatio = width / height;
            
            if (width > maxWidth) {
                width = maxWidth;
                height = width / aspectRatio;
            }
            
            if (height > maxHeight) {
                height = maxHeight;
                width = height * aspectRatio;
            }
            
            canvas.width = width;
            canvas.height = height;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
        }
        
        function drawImage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            // Draw existing annotations
            annotations.forEach(ann => drawAnnotation(ann));
        }
        
        function drawAnnotation(annotation) {
            const { x, y, width, height, category } = annotation;
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, width, height);
            
            // Draw category label
            ctx.fillStyle = '#00ff00';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(categoryNames[category], x, y - 5);
        }
        
        function selectCategory(btn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedCategory = parseInt(btn.dataset.category);
        }
        
        function startDrawing(e) {
            if (selectedCategory === null) {
                showNotification('×‘×—×¨ ×§×˜×’×•×¨×™×” ×ª×—×™×œ×”', 'error');
                return;
            }
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
        }
        
        function drawBoundingBox(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            drawImage();
            
            // Draw current bounding box
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        }
        
        function endDrawing(e) {
            if (!isDrawing) return;
            
            isDrawing = false;
            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;
            
            const x = Math.min(startX, endX);
            const y = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);
            
            if (width > 20 && height > 20) {
                annotations.push({
                    x, y, width, height,
                    category: selectedCategory
                });
                drawImage();
            }
        }
        
        function clearCanvas() {
            annotations = [];
            drawImage();
        }
        
        function resetUpload() {
            currentImage = null;
            selectedCategory = null;
            annotations = [];
            document.getElementById('categorySection').classList.add('hidden');
            document.getElementById('canvasSection').classList.add('hidden');
            document.getElementById('imageInput').value = '';
            document.getElementById('qualitySlider').value = 7;
            document.getElementById('ratingValue').textContent = '7';
            document.getElementById('ratingText').textContent = '×˜×•×‘';
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
        }
        
        async function saveAnnotation() {
            if (!currentImage || annotations.length === 0) {
                showNotification('××™×Ÿ ×× ×•×˜×¦×™×•×ª ×œ×©×ž×•×¨', 'error');
                return;
            }
            
            try {
                showNotification('×©×•×ž×¨...', 'success');
                const qualityRating = parseInt(document.getElementById('qualitySlider').value);
                
                if (supabase) {
                    // Save to Supabase
                    await saveToSupabase(qualityRating);
                } else {
                    // Save locally
                    saveLocally(qualityRating);
                }
                
                showNotification(`× ×©×ž×¨ ×‘×”×¦×œ×—×”! ${annotations.length} ××•×‘×™×™×§×˜×™×, ×¦×™×•×Ÿ: ${qualityRating}/10`, 'success');
                resetUpload();
                loadStats();
                loadGallery();
                
            } catch (error) {
                console.error('Error saving annotation:', error);
                showNotification('×©×’×™××” ×‘×©×ž×™×¨×”', 'error');
            }
        }
        
        async function saveToSupabase(qualityRating) {
            // Convert canvas to blob
            const blob = await new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.8);
            });
            
            // Upload image to Supabase Storage
            const fileName = `${Date.now()}_${currentUser}_${Math.random().toString(36).substr(2, 9)}.jpg`;
            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('images')
                .upload(fileName, blob);
            
            if (uploadError) {
                throw new Error('Upload failed: ' + uploadError.message);
            }
            
            // Convert annotations to YOLO format
            const yoloAnnotations = annotations.map(ann => {
                const centerX = (ann.x + ann.width / 2) / canvas.width;
                const centerY = (ann.y + ann.height / 2) / canvas.height;
                const width = ann.width / canvas.width;
                const height = ann.height / canvas.height;
                return {
                    category: ann.category,
                    center_x: centerX,
                    center_y: centerY,
                    width: width,
                    height: height
                };
            });
            
            // Save to database
            const { data, error } = await supabase
                .from('annotations')
                .insert([{
                    user_name: currentUser,
                    image_path: fileName,
                    annotations: yoloAnnotations,
                    quality_rating: qualityRating,
                    created_at: new Date().toISOString()
                }]);
            
            if (error) {
                throw new Error('Database save failed: ' + error.message);
            }
        }
        
        function saveLocally(qualityRating) {
            const localData = JSON.parse(localStorage.getItem('yolo_dataset') || '[]');
            
            const yoloAnnotations = annotations.map(ann => {
                const centerX = (ann.x + ann.width / 2) / canvas.width;
                const centerY = (ann.y + ann.height / 2) / canvas.height;
                const width = ann.width / canvas.width;
                const height = ann.height / canvas.height;
                return {
                    category: ann.category,
                    center_x: centerX,
                    center_y: centerY,
                    width: width,
                    height: height
                };
            });
            
            localData.push({
                id: Date.now(),
                user_name: currentUser,
                annotations: yoloAnnotations,
                quality_rating: qualityRating,
                image_data: canvas.toDataURL('image/jpeg', 0.8),
                created_at: new Date().toISOString()
            });
            
            localStorage.setItem('yolo_dataset', JSON.stringify(localData));
        }
        
        async function loadStats() {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = '<div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
            
            try {
                let stats;
                if (supabase) {
                    stats = await loadStatsFromSupabase();
                } else {
                    stats = loadStatsLocally();
                }
                
                statsContainer.innerHTML = [
                    { title: '×¡×š ×ª×ž×•× ×•×ª', value: stats.totalImages, icon: 'ðŸ“·' },
                    { title: '×¡×š ××•×‘×™×™×§×˜×™×', value: stats.totalObjects, icon: 'ðŸ·ï¸? },
                    { title: '×ž×ª×™×™×’×™× ×¤×¢×™×œ×™×', value: stats.uniqueUsers, icon: 'ðŸ‘¥' },
                    { title: '×¦×™×•×Ÿ ××™×›×•×ª ×ž×ž×•×¦×¢', value: stats.avgQuality, icon: 'â­? }
                ].map(stat => `
                    <div class="stat-card">
                        <div style="font-size: 2em; margin-bottom: 10px;">${stat.icon}</div>
                        <div class="stat-number">${stat.value}</div>
                        <div>${stat.title}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Stats loading error:', error);
                statsContainer.innerHTML = '<div class="loading">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</div>';
            }
        }
        
        async function loadStatsFromSupabase() {
            const { data, error } = await supabase
                .from('annotations')
                .select('user_name, annotations, quality_rating');
            
            if (error) throw error;
            
            const totalImages = data.length;
            const totalObjects = data.reduce((sum, item) => sum + item.annotations.length, 0);
            const uniqueUsers = new Set(data.map(item => item.user_name)).size;
            const avgQuality = data.length > 0 
                ? (data.reduce((sum, item) => sum + item.quality_rating, 0) / data.length).toFixed(1)
                : '0.0';
            
            return { totalImages, totalObjects, uniqueUsers, avgQuality };
        }
        
        function loadStatsLocally() {
            const localData = JSON.parse(localStorage.getItem('yolo_dataset') || '[]');
            const totalImages = localData.length;
            const totalObjects = localData.reduce((sum, item) => sum + item.annotations.length, 0);
            const uniqueUsers = new Set(localData.map(item => item.user_name)).size;
            const avgQuality = localData.length > 0
                ? (localData.reduce((sum, item) => sum + item.quality_rating, 0) / localData.length).toFixed(1)
                : '0.0';
            
            return { totalImages, totalObjects, uniqueUsers, avgQuality };
        }
        
        async function loadGallery() {
            const gallery = document.getElementById('imageGallery');
            gallery.innerHTML = '<div class="loading">×˜×•×¢×Ÿ ×ª×ž×•× ×•×ª...</div>';
            
            try {
                let images;
                if (supabase) {
                    images = await loadGalleryFromSupabase();
                } else {
                    images = loadGalleryLocally();
                }
                
                if (images.length === 0) {
                    gallery.innerHTML = '<div class="loading">××™×Ÿ ×ª×ž×•× ×•×ª ×¢×“×™×™×Ÿ. ×”×ª×—×œ ×œ×¦×œ×! ðŸ“¸</div>';
                    return;
                }
                
                gallery.innerHTML = images.map(img => `
                    <div class="image-card" onclick="viewImage('${img.id}')">
                        <img src="${img.imageUrl}" alt="×ª×ž×•× ×”">
                        <div class="image-card-info">
                            <div><strong>${img.userName}</strong></div>
                            <div>${img.objectCount} ××•×‘×™×™×§×˜×™×</div>
                            <div>â­?${img.quality}/10</div>
                            <div style="font-size: 0.8em; opacity: 0.7;">${img.date}</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Gallery loading error:', error);
                gallery.innerHTML = '<div class="loading">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×ž×•× ×•×ª</div>';
            }
        }
        
        async function loadGalleryFromSupabase() {
            const { data, error } = await supabase
                .from('annotations')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            return Promise.all(data.map(async item => {
                const { data: urlData } = supabase.storage
                    .from('images')
                    .getPublicUrl(item.image_path);
                
                return {
                    id: item.id,
                    userName: item.user_name,
                    imageUrl: urlData.publicUrl,
                    objectCount: item.annotations.length,
                    quality: item.quality_rating,
                    date: new Date(item.created_at).toLocaleDateString('he-IL')
                };
            }));
        }
        
        function loadGalleryLocally() {
            const localData = JSON.parse(localStorage.getItem('yolo_dataset') || '[]');
            return localData.slice(-20).reverse().map(item => ({
                id: item.id,
                userName: item.user_name,
                imageUrl: item.image_data,
                objectCount: item.annotations.length,
                quality: item.quality_rating,
                date: new Date(item.created_at).toLocaleDateString('he-IL')
            }));
        }
        
        function viewImage(imageId) {
            showNotification('×¤×•× ×§×¦×™×™×ª ×”×¦×’×” ×‘×¤×™×ª×•×—', 'success');
        }
        
        async function exportDataset() {
            const exportProgress = document.getElementById('exportProgress');
            exportProgress.classList.remove('hidden');
            
            try {
                let dataset;
                if (supabase) {
                    dataset = await exportFromSupabase();
                } else {
                    dataset = exportFromLocal();
                }
                
                // Create YOLO format files
                const zip = {
                    classes: categories,
                    data: dataset,
                    info: {
                        total_images: dataset.length,
                        total_objects: dataset.reduce((sum, item) => sum + item.annotations.length, 0),
                        exported_at: new Date().toISOString(),
                        format: 'YOLO'
                    }
                };
                
                const dataStr = JSON.stringify(zip, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `yolo_dataset_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('×”× ×ª×•× ×™× ×™×•×¦××• ×‘×”×¦×œ×—×”!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('×©×’×™××” ×‘×™×™×¦×•× ×”× ×ª×•× ×™×', 'error');
            } finally {
                exportProgress.classList.add('hidden');
            }
        }
        
        async function exportFromSupabase() {
            const { data, error } = await supabase
                .from('annotations')
                .select('*');
            
            if (error) throw error;
            
            return data.map(item => ({
                user_name: item.user_name,
                image_path: item.image_path,
                annotations: item.annotations,
                quality_rating: item.quality_rating,
                created_at: item.created_at
            }));
        }
        
        function exportFromLocal() {
            const localData = JSON.parse(localStorage.getItem('yolo_dataset') || '[]');
            return localData.map(item => ({
                user_name: item.user_name,
                image_data: item.image_data,
                annotations: item.annotations,
                quality_rating: item.quality_rating,
                created_at: item.created_at
            }));
        }
        
        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>
